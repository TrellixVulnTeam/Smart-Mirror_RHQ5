class AssistantResponse{constructor(t,e){this.config=t,this.callbacks=e,this.showing=!1,this.response=null,this.aliveTimer=null,this.allStatus=["hook","standby","reply","error","think","continue","listen","confirmation"],this.myStatus={actual:"standby",old:"standby"},this.loopCount=0,this.chime=this.config.chimes,this.resourcesDir="/modules/MMM-GoogleAssistant/resources/",this.warningEvent=!1,this.imgStatus={hook:this.resourcesDir+this.config.imgStatus.hook,standby:this.resourcesDir+this.config.imgStatus.standby,reply:this.resourcesDir+this.config.imgStatus.reply,error:this.resourcesDir+this.config.imgStatus.error,think:this.resourcesDir+this.config.imgStatus.think,continue:this.resourcesDir+this.config.imgStatus.continue,listen:this.resourcesDir+this.config.imgStatus.listen,confirmation:this.resourcesDir+this.config.imgStatus.confirmation,information:this.resourcesDir+this.config.imgStatus.information,warning:this.resourcesDir+this.config.imgStatus.warning,userError:this.resourcesDir+this.config.imgStatus.userError},this.audioResponse=new Audio,this.audioResponse.autoplay=!0,this.audioResponse.addEventListener("ended",(()=>{logGA("audio end"),this.end()})),this.audioChime=new Audio,this.audioChime.autoplay=!0,this.fullscreenAbove=this.config.useFullscreen,this.warningTimeout=null,this.infosDiv=null,this.infoWarning=new Audio,this.infoWarning.autoplay=!0}tunnel(t){if("TRANSCRIPTION"==t.type){var e=!1;if(t.payload.done)this.status("confirmation"),document.getElementById("GA-ResultOuput").src="about:blank";t.payload.transcription&&!e&&(this.showTranscription(t.payload.transcription),e=!0)}}playChime(t,e){this.config.useChime&&(this.audioChime.src=this.resourcesDir+(e?t:this.chime[t]))}status(t,e){this.myStatus.actual=t;var s=document.getElementById("GA-Status");e&&"continue"!=this.myStatus.old&&this.playChime("beep"),"error"!=t&&"continue"!=t||this.playChime(t),"confirmation"==t&&this.config.confirmationChime&&this.playChime("confirmation"),"WAVEFILE"!=t&&"TEXT"!=t||(this.myStatus.actual="think"),"MIC"==t&&(this.myStatus.actual="continue"==this.myStatus.old?"continue":"listen"),this.myStatus.actual!=this.myStatus.old&&(logGA("Status from "+this.myStatus.old+" to "+this.myStatus.actual),s.src="hook"==this.myStatus.old?this.imgStatus.hook:this.imgStatus[this.myStatus.actual],this.callbacks.myStatus(this.myStatus),this.myStatus.old=this.myStatus.actual)}preparePopup(){var t=document.createElement("div");t.id="GAv3",document.body.appendChild(t)}prepareGA(){var t=document.getElementById("GAv3"),e=document.createElement("div");e.id="Infos",e.style.zoom=this.config.zoom.transcription,e.className="hidden animate__animated",e.style.setProperty("--animate-duration","1s");var s=document.createElement("div");s.id="InfoDisplay",e.appendChild(s);var i=document.createElement("div");i.id="Infos-popout",s.appendChild(i);var n=document.createElement("div");n.id="Infos-bar",n.className="Infos-popout-asbar",n.tabindex=-1,i.appendChild(n);var o=document.createElement("img");o.id="Infos-Icon",o.className="Infos-assistant_icon",o.src=this.resourcesDir+"information.gif",n.appendChild(o);var a=document.createElement("span");a.id="Infos-Transcription",a.className="Infos-assistant_response",a.textContent="~MMM-GoogleAssistant v3 Informations displayer~",n.appendChild(a),t.appendChild(e);var r=document.createElement("div");r.id="GA",r.style.zoom=this.config.zoom.transcription,r.className="hidden out",r.addEventListener("transitionend",(t=>{"out"==t.path[0].className&&r.classList.add("hidden")}));var u=document.createElement("div");u.id="GA-Result",u.classList.add("hidden");var l=document.createElement("iframe");l.id="GA-ResultOuput",u.appendChild(l),r.appendChild(u);var c=document.createElement("div");c.id="GA-Response",r.appendChild(c);var d=document.createElement("div");d.id="GA-popout",c.appendChild(d);var h=document.createElement("div");h.id="GA-assistant-bar",h.className="GA-popout-asbar",h.tabindex=-1,d.appendChild(h);var m=document.createElement("img");m.id="GA-Status",m.className="GA-assistant_icon",m.src=this.resourcesDir+"standby.gif",h.appendChild(m);var p=document.createElement("span");p.id="GA-Transcription",p.className="GA-assistant_response",p.textContent="~MMM-GoogleAssistant~",h.appendChild(p);var g=document.createElement("div");g.className="GA-assistant-word-icon",h.appendChild(g);var y=document.createElement("img");y.className="GA-bar_icon",y.src=this.resourcesDir+"assistant_tv_logo.svg",g.appendChild(y),t.appendChild(r),this.infosDiv=document.getElementById("Infos")}prepareBackground(){var t=document.getElementsByClassName("region fullscreen above")[0].querySelector(".container"),e=t.children,s=document.createElement("div");s.id="module_Fake_GA_DOM",s.classList.add("module","GA_DOM","hidden");var i=document.createElement("header");i.classList.add("module-header"),i.style.display="none",s.appendChild(i);var n=document.createElement("div");n.classList.add("module-content");var o=document.createElement("div");o.id="GA_DOM",n.appendChild(o),s.appendChild(n),t.insertBefore(s,e[e.length])}showError(t){return this.showTranscription(t,"error"),this.status("error"),!0}showTranscription(t){document.getElementById("GA-Transcription").textContent=t}end(t=!0){if(this.showing=!1,this.response){var e=this.response;this.response=null,e&&e.continue?(this.loopCount=0,this.status("continue"),logGA("Continuous Conversation"),this.showTranscription(""),this.callbacks.assistantActivate({type:"MIC",profile:e.lastQuery.profile,key:null,lang:e.lastQuery.lang,useResponseOutput:e.lastQuery.useResponseOutput,force:!0},Date.now())):(logGA("Conversation ends."),this.status("standby"),this.callbacks.endResponse(),clearTimeout(this.aliveTimer),this.aliveTimer=null,this.aliveTimer=setTimeout((()=>{this.stopResponse((()=>{this.fullscreen(!1,this.myStatus)}))}),this.config.screenOutputTimer))}else this.status("standby"),this.fullscreen(!1,this.myStatus),t&&this.callbacks.endResponse()}start(t){if(this.response=t,clearTimeout(this.aliveTimer),this.aliveTimer=null,this.showing&&this.end(),t.error.error)return"TRANSCRIPTION_FAILS"==t.error.error?(logGA("Transcription Failed. Re-try with text"),void this.callbacks.assistantActivate({type:"TEXT",profile:t.lastQuery.profile,key:t.transcription.transcription,lang:t.lastQuery.lang,useResponseOutput:t.lastQuery.useResponseOutput,force:!0,chime:!1},null)):"TOO_SHORT"==t.error.error&&"continue"==t.lastQuery.status&&this.loopCount<3?(this.status("continue"),this.callbacks.assistantActivate({type:"MIC",profile:t.lastQuery.profile,key:null,lang:t.lastQuery.lang,useResponseOutput:t.lastQuery.useResponseOutput,force:!0},Date.now()),this.loopCount+=1,void logGA("Loop Continuous Count: "+this.loopCount+"/3")):(this.showError(t.error.message?t.error.message:this.callbacks.translate(t.error.error)),void this.end());var e=t=>{this.showing=!0,this.callbacks.EXT(t),this.status("reply");this.showScreenOutput(t);this.playAudioOutput(t)?logGA("Wait audio to finish"):(logGA("No response"),this.end())};this.postProcess(t,(()=>{t.continue=!1,this.end()}),(()=>{e(t)}))}stopResponse(t=(()=>{})){this.showing=!1,document.getElementById("GA-Result").classList.add("hidden"),this.audioResponse.src="",document.getElementById("GA-Transcription").textContent="",t()}postProcess(t,e=(()=>{}),s=(()=>{})){this.callbacks.postProcess(t,e,s)}playAudioOutput(t){return!(!t.audio||!this.config.useAudioOutput)&&(this.showing=!0,this.audioResponse.src=this.makeUrl(t.audio.uri),!0)}showScreenOutput(t){return!this.sercretMode&&t.screen&&this.config.useResponseOutput?(t.audio||this.showTranscription(this.callbacks.translate("NO_AUDIO_RESPONSE")),this.showing=!0,document.getElementById("GA-ResultOuput").src=this.makeUrl(t.screen.uri),document.getElementById("GA-Result").classList.remove("hidden"),!0):!(!t.text||this.config.useResponseOutput)&&(this.showTranscription(t.text),!0)}makeUrl(t){return"/modules/MMM-GoogleAssistant/"+t+"?seed="+Date.now()}fullscreen(t,e,s=!0){var i=document.getElementById("GA"),n=document.getElementById("module_Fake_GA_DOM");t?(i.className="in",this.fullscreenAbove&&s&&(n.classList.remove("hidden"),MM.getModules().enumerate((t=>{t.hide(500,{lockString:"GA_LOCKED"})})))):e&&"standby"==e.actual&&(i.className="out",this.fullscreenAbove&&(n.classList.add("hidden"),MM.getModules().enumerate((t=>{t.show(500,{lockString:"GA_LOCKED"})}))))}forceStatusImg(t){document.getElementById("GA-Status").src=this.imgStatus[t]}}