class Spotify{constructor(e,t,i){this.config=e,this.debug=i,this.spotifyStatus=t.spotifyStatus,this.currentPlayback=null,this.connected=!1,this.timer=null,this.ads=!1,console.log("[GA:EXT] Spotify Loaded")}prepare(){var e=document.getElementsByClassName("region bottom bar")[0].querySelector(".container"),t=e.children,i=document.createElement("div");i.id="module_EXT_Spotify",i.style.display="none",i.classList.add("module","EXT_Spotify");var n=document.createElement("header");n.classList.add("module-header"),n.style.display="none",i.appendChild(n);var s=document.createElement("div");s.classList.add("module-content");var a=document.createElement("div");a.id="EXT_SPOTIFY",a.classList.add("inactive"),s.appendChild(a),i.appendChild(s),e.insertBefore(i,t[t.length]),this.getMinimalistBarDom(a)}prepareMini(){var e=document.createElement("div");e.id="EXT_SPOTIFY",e.className="inactive mini animate__animated",e.style.setProperty("--animate-duration","1s"),e.appendChild(this.getHTMLElementWithID("div","EXT_SPOTIFY_BACKGROUND"));const t=this.getHTMLElementWithID("img","EXT_SPOTIFY_COVER_IMAGE");t.className="fade-in";const i=this.getHTMLElementWithID("div","EXT_SPOTIFY_COVER");i.appendChild(t);const n=this.getHTMLElementWithID("div","EXT_SPOTIFY_MISC");n.appendChild(this.getInfoContainer()),n.appendChild(this.getVolumeContainer()),n.appendChild(this.getProgressContainer()),n.appendChild(this.getSpotifyLogoContainer());const s=this.getHTMLElementWithID("div","EXT_SPOTIFY_FOREGROUND");return s.appendChild(i),s.appendChild(n),e.appendChild(s),e}updatePlayback(e){var t=document.getElementById("EXT_SPOTIFY");clearTimeout(this.timer),this.timer=null,this.connected&&!e&&(this.debug&&console.log("[SPOTIFY] Disconnected"),this.connected=!1,this.spotifyStatus(!1),this.config.useBottomBar?(t.classList.remove("bottomIn"),t.classList.add("bottomOut"),this.timer=setTimeout((()=>{t.classList.add("inactive"),module.style.display="none"}),500)):(t.classList.remove("animate__flipInX"),t.classList.add("animate__flipOutX"),t.addEventListener("animationend",(e=>{"flipOutX"==e.animationName&&"EXT_SPOTIFY"==e.path[0].id&&t.classList.add("inactive"),e.stopPropagation()}),{once:!0}))),!this.connected&&e&&(this.debug&&console.log("[SPOTIFY] Connected"),this.connected=!0,this.spotifyStatus(!0),t.classList.remove("inactive"),this.config.useBottomBar?(module.style.display="block",t.classList.remove("bottomOut"),t.classList.add("bottomIn")):(t.classList.remove("animate__flipOutX"),t.classList.add("animate__flipInX")))}updateCurrentSpotify(e){if(e){if(this.currentPlayback){if(!this.connected&&e.is_playing&&this.updatePlayback(!0),"ad"==e.currently_playing_type&&(this.ads=!0,e.is_playing=!1),this.currentPlayback.is_playing!==e.is_playing&&this.updatePlaying(e.is_playing),"ad"==e.currently_playing_type)return void(this.currentPlayback.is_playing=!1);if(this.ads)return this.currentPlayback=null,void(this.ads=!1);if(!(e.item&&e.device&&e.progress_ms&&e.item.duration_ms))return this.currentPlayback=null;this.currentPlayback.item.id!==e.item.id&&this.updateSongInfo(e.item),this.currentPlayback.device.id!==e.device.id&&this.updateDevice(e.device),this.currentPlayback.device.volume_percent!==e.device.volume_percent&&this.updateVolume(e.device.volume_percent),this.currentPlayback.progress_ms!==e.progress_ms&&this.updateProgress(e.progress_ms,e.item.duration_ms)}else this.updateSongInfo(e.item),this.updatePlaying(e.is_playing),this.updateDevice(e.device),this.updatePlayback(e.is_playing),e.device&&this.updateVolume(e.device.volume_percent),e.is_playing&&e.item&&this.updateProgress(e.progress_ms,e.item.duration_ms);this.currentPlayback=e}}msToTime(e){let t="",i=parseInt(e/1e3%60),n=parseInt(e/6e4%60),s=parseInt(e/36e5%24);return s>0&&(s=s<10?"0"+s:s,t=t+s+":"),n=n<10?"0"+n:n,i=i<10?"0"+i:i,t+n+":"+i}updateProgress(e,t){const i=document.getElementById("EXT_SPOTIFY_PROGRESS_BAR");if(i.value=e,i.max!=t&&(i.max=t),this.config.useBottomBar){document.getElementById("EXT_SPOTIFY_PROGRESS_COMBINED").innerText=this.msToTime(e)+" / "+this.msToTime(t)}}updateDevice(e){const t=document.querySelector("#EXT_SPOTIFY_DEVICE .text"),i=document.getElementById("EXT_SPOTIFY_DEVICE_ICON");t.textContent=this.config.deviceDisplay+" "+e.name,i.className=this.getFAIconClass(e.type)}updateVolume(e){const t=document.querySelector("#EXT_SPOTIFY_VOLUME .text"),i=document.getElementById("EXT_SPOTIFY_VOLUME_ICON");t.textContent=e+"%",i.className=this.getVolumeIconClass(e)}getVolumeIconClass(e){let t="VOL_OFF";return 0===e||(t=e<40?"VOL_LOW":e>70?"VOL_HIGH":"VOL_MID"),this.getFAIconClass(t)}updatePlaying(e){const t=document.getElementById("EXT_SPOTIFY");if(e?(t.classList.add("playing"),t.classList.remove("pausing")):(t.classList.add("pausing"),t.classList.remove("playing")),"hidden"!==this.config.control&&this.config.useBottomBar){const t=document.getElementById("EXT_SPOTIFY_CONTROL_PLAY");t.className=e?"playing":"pausing";const i=e?"mdi:play-circle-outline":"mdi:pause-circle-outline";t.innerHTML="",t.appendChild(this.getIconContainer("iconify","EXT_SPOTIFY_CONTROL_PLAY_ICON",i))}}updateSongInfo(e){if(!e)return;document.getElementById("EXT_SPOTIFY");const t=document.getElementById("EXT_SPOTIFY_COVER_IMAGE");let i=this.config.useBottomBar?2:1;var n,s;if(e.album?(n=e.album.images[i].url,s=e.album.name):(n=e.images[i].url,s=e.show.name),n!==t.src){if(!this.config.useBottomBar){const e=document.getElementById("EXT_SPOTIFY_BACKGROUND");e.classList.remove("fade-in");t.offsetWidth;e.classList.add("fade-in"),e.style.backgroundImage=`url(${n})`}t.classList.remove("fade-in");t.offsetWidth;t.classList.add("fade-in"),t.src=n}if(document.querySelector("#EXT_SPOTIFY_TITLE .text").textContent=e.name,!this.config.useBottomBar){document.querySelector("#EXT_SPOTIFY_ALBUM .text").textContent=s}const a=document.querySelector("#EXT_SPOTIFY_ARTIST .text"),o=e.artists;let d="";if(e.album)for(let e=0;e<o.length;e++)d?d+=", "+o[e].name:d=o[e].name;else d=e.show.publisher;a.textContent=d}getFAIcon(e){switch(e){case"Spotify":return"fab fa-spotify fa-sm";case"Title":return"fa fa-music fa-sm";case"Artist":return"fa fa-user fa-sm";case"Album":return"fa fa-folder fa-sm";case"VOL_HIGH":return"mdi mdi-volume-high";case"VOL_MID":return"mdi mdi-volume-medium";case"VOL_LOW":return"mdi mdi-volume-low";case"VOL_OFF":return"mdi mdi-volume-off";case"Tablet":return"fas fa-tablet fa-sm";case"GameConsole":return"fas fa-gamepad fa-sm";case"AVR":case"STB":return"mdi mdi-audio-video";case"AudioDongle":case"CastVideo":return"mdi mdi-cast-connected";case"CastAudio":case"Speaker":return"mdi mdi-cast-audio";case"Automobile":return"fas fa-car fa-sm";case"Smartphone":return"fas fa-mobile fa-sm";case"TV":return"fas fa-tv fa-sm";case"Unknown":case"Computer":return"fa fa-desktop fa-sm";default:return"fa fa-headphones fa-sm"}}getFAIconClass(e){return"infoicon "+this.getFAIcon(e)}getIconContainer(e,t,i){const n=document.createElement("i");return n.className=e,n.dataset.inline="false",n.id=t,n.dataset.icon=i,n}getHTMLElementWithID(e,t){const i=document.createElement(e);return i.id=t,i}getEmptyTextHTMLElement(){const e=document.createElement("span");return e.className="text",e.textContent="",e}getDeviceContainer(){const e=this.getHTMLElementWithID("div","EXT_SPOTIFY_DEVICE");return e.appendChild(this.getIconContainer(this.getFAIconClass("default"),"EXT_SPOTIFY_DEVICE_ICON")),e.appendChild(this.getEmptyTextHTMLElement()),e}getVolumeContainer(){const e=this.getHTMLElementWithID("div","EXT_SPOTIFY_VOLUME");return e.appendChild(this.getIconContainer(this.getFAIconClass("VOL_OFF"),"EXT_SPOTIFY_VOLUME_ICON")),e.appendChild(this.getEmptyTextHTMLElement()),e}getSpotifyLogoContainer(){const e=this.getHTMLElementWithID("div","EXT_SPOTIFY_LOGO");e.appendChild(this.getIconContainer(this.getFAIconClass("Spotify"),"EXT_SPOTIFY_LOGO_ICON"));const t=document.createElement("span");return t.className="text",t.textContent=this.config.SpotifyForGA,e.appendChild(t),e}getControlButton(e,t){const i=this.getHTMLElementWithID("div",e);return i.className="off",i.appendChild(this.getIconContainer("iconify",e+"_ICON",t)),i}getInfoContainer(){const e=this.getHTMLElementWithID("div","EXT_SPOTIFY_INFO"),t={EXT_SPOTIFY_TITLE:"Title",EXT_SPOTIFY_ALBUM:"Album",EXT_SPOTIFY_ARTIST:"Artist"};for(const[i,n]of Object.entries(t)){const t=this.getHTMLElementWithID("div",i);t.appendChild(this.getIconContainer(this.getFAIconClass(n))),t.appendChild(this.getEmptyTextHTMLElement()),e.appendChild(t)}return e.appendChild(this.getDeviceContainer()),e}getProgressContainer(){const e=this.getHTMLElementWithID("div","EXT_SPOTIFY_PROGRESS"),t=this.getHTMLElementWithID("progress","EXT_SPOTIFY_PROGRESS_BAR");return t.value=0,t.max=100,e.appendChild(t),e}getCoverContainer(){const e=this.getHTMLElementWithID("img","EXT_SPOTIFY_COVER_IMAGE");e.className="fade-in";const t=this.getHTMLElementWithID("div","EXT_SPOTIFY_COVER");return t.appendChild(e),t}getMinimalistBarDom(e){e.appendChild(this.getProgressContainer());const t=this.getHTMLElementWithID("div","EXT_SPOTIFY_MISC");t.appendChild(this.getDeviceContainer());const i=this.getHTMLElementWithID("div","EXT_SPOTIFY_INFO");["EXT_SPOTIFY_TITLE","EXT_SPOTIFY_ARTIST"].forEach(((e,t)=>{if(t>0){const e=this.getHTMLElementWithID("span","TEXT_BULLET");e.innerHTML="&#8226;",i.appendChild(e)}const n=this.getHTMLElementWithID("div",e);n.appendChild(this.getEmptyTextHTMLElement()),i.appendChild(n)})),t.appendChild(i);const n=this.getHTMLElementWithID("div","EXT_SPOTIFY_INFO_FOOTER");n.appendChild(this.getVolumeContainer()),n.appendChild(this.getSpotifyLogoContainer());const s=this.getHTMLElementWithID("div","EXT_SPOTIFY_PROGRESS_COMBINED");s.className="text",s.innerText="--:-- / --:--",n.appendChild(s),t.appendChild(n);const a=this.getHTMLElementWithID("div","EXT_SPOTIFY_FOREGROUND");return a.appendChild(this.getCoverContainer()),a.appendChild(t),a.appendChild(this.getControlButton("EXT_SPOTIFY_CONTROL_PLAY","mdi:play-circle-outline")),e.appendChild(a),e}getConnected(){return this.connected}}